[gd_scene load_steps=7 format=3 uid="uid://dyaiwc0ri4egl"]

[ext_resource type="Texture2D" uid="uid://dlkq44lcbx0h" path="res://assets/icon.svg" id="1_x7aqs"]

[sub_resource type="GDScript" id="GDScript_uypmy"]
script/source = "extends Node

signal player_list_changed

const PORT = 23339

var player_name: String

var players := {}

@rpc(\"call_local\", \"any_peer\")
func register_player(player_nam: String):
	players[multiplayer.get_remote_sender_id()] = player_nam
	player_list_changed.emit()

# Called when the node enters the scene tree for the first time.
func _ready():
	Steam.steamInitEx(true, 480)
	print(get_tree_string())
	get_tree().paused = true
	
	multiplayer.peer_connected.connect(
		func(id: int):
			register_player.rpc_id(id, player_name)
	)
	
	Steam.lobby_game_created
	 

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(_delta):
	Steam.run_callbacks()
	
func spawn_player(peer_id):
	# server-only
	var player_scene := load(\"res://mech.tscn\")
	var player = player_scene.instantiate()
	$Players.add_child(player, true)
	player.set_authority.rpc(peer_id)
	player.position = $SpawnPoint.position + Vector2(randi() % 200, randi() % 200)
	player.set_player_name()
	print($Players.get_children())

func _on_host_pressed():
	var peer = ENetMultiplayerPeer.new()
	peer.create_server(PORT)
	multiplayer.multiplayer_peer = peer
	players[1] = player_name
	print(\"Hosting\") 
	$UI/Net/Options/Start.disabled = false
	
func _on_join_pressed():
	var address: String = $UI/Net/Options/Adress.text
	var peer = ENetMultiplayerPeer.new()
	peer.create_client(address, PORT)
	multiplayer.multiplayer_peer = peer
	await multiplayer.connected_to_server
	register_player.rpc(player_name)
	players[multiplayer.get_unique_id()] = player_name
	print(\"Joined\")
	
func start_game():
	# server-only
	assert(multiplayer.is_server())
	
	# start game on all clients
	start_world.rpc()
	
	for peer_id in players:
		print(\"Peer id: \", peer_id)
		spawn_player(peer_id)
		
	
@rpc(\"call_local\")
func start_world():
	$UI.hide()
	get_tree().paused = false
	


func _on_button_pressed():
	print(\"przyicsk\")
"

[sub_resource type="PhysicsMaterial" id="PhysicsMaterial_eckjc"]

[sub_resource type="RectangleShape2D" id="RectangleShape2D_6sm7r"]
size = Vector2(589, 51)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_7nbld"]
size = Vector2(89, 150)

[sub_resource type="Theme" id="Theme_xxmnq"]

[node name="Node2D" type="Node2D"]

[node name="Multiplayer" type="Node" parent="."]
script = SubResource("GDScript_uypmy")

[node name="Sciany" type="StaticBody2D" parent="Multiplayer"]
position = Vector2(162, 303)
physics_material_override = SubResource("PhysicsMaterial_eckjc")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Multiplayer/Sciany"]
position = Vector2(176.5, -1.5)
shape = SubResource("RectangleShape2D_6sm7r")

[node name="CollisionShape2D2" type="CollisionShape2D" parent="Multiplayer/Sciany"]
position = Vector2(440.5, -95)
shape = SubResource("RectangleShape2D_7nbld")
debug_color = Color(0.842893, 0.00106523, 0.916572, 0.42)

[node name="Sprite2D" type="Sprite2D" parent="Multiplayer/Sciany/CollisionShape2D2"]
position = Vector2(19.5, 1)
texture = ExtResource("1_x7aqs")

[node name="UI" type="CanvasLayer" parent="Multiplayer"]
process_mode = 3

[node name="Net" type="VBoxContainer" parent="Multiplayer/UI"]
offset_left = -1.0
offset_top = 1.0
offset_right = 572.0
offset_bottom = 124.0
mouse_filter = 2

[node name="Options" type="HBoxContainer" parent="Multiplayer/UI/Net"]
layout_mode = 2

[node name="Label" type="Label" parent="Multiplayer/UI/Net/Options"]
layout_mode = 2
text = "Direct:
"

[node name="Host" type="Button" parent="Multiplayer/UI/Net/Options"]
layout_mode = 2
theme = SubResource("Theme_xxmnq")
text = "Host"

[node name="Connect" type="Button" parent="Multiplayer/UI/Net/Options"]
layout_mode = 2
text = "Connect:"

[node name="Adress" type="LineEdit" parent="Multiplayer/UI/Net/Options"]
layout_mode = 2
text = "127.0.0.1"
expand_to_text_length = true

[node name="Start" type="Button" parent="Multiplayer/UI/Net/Options"]
layout_mode = 2
disabled = true
text = "Start"

[node name="Players" type="Node" parent="Multiplayer"]

[node name="SpawnPoint" type="Marker2D" parent="Multiplayer"]
position = Vector2(312.035, 179.567)

[node name="MultiplayerSpawner" type="MultiplayerSpawner" parent="Multiplayer"]
spawn_path = NodePath("../Players")

[connection signal="pressed" from="Multiplayer/UI/Net/Options/Host" to="Multiplayer" method="_on_host_pressed"]
[connection signal="pressed" from="Multiplayer/UI/Net/Options/Connect" to="Multiplayer" method="_on_join_pressed"]
[connection signal="pressed" from="Multiplayer/UI/Net/Options/Start" to="Multiplayer" method="start_game"]
